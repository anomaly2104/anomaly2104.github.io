---           
layout: post
title: Handling composed character sequences/character clusters in NSString
date: 2014-09-30 11:25:07 UTC
updated: 2014-09-30 11:25:07 UTC
comments: false
categories: apple character clusters characters composed character sequences iOS NSString Objective-C Unicode user visible characters
---

<div dir="ltr" style="text-align: left;" trbidi="on"><div style="background: rgb(255, 255, 255); border: 0px; clear: both; font-family: Arial, 'Liberation Sans', 'DejaVu Sans', sans-serif; font-size: 14px; line-height: 17.8048000335693px; margin-bottom: 1em; padding: 0px; vertical-align: baseline;">String handling was a bit different in 'C' world. Everything was ascii C string</div><pre style="-webkit-box-shadow: none; background-color: #002b36; background-image: none; border-bottom-left-radius: 0.4em; border-bottom-right-radius: 0.4em; border-top-left-radius: 0.4em; border-top-right-radius: 0.4em; border: none; box-shadow: none; font-family: Menlo, Monaco, 'Andale Mono', 'lucida console', 'Courier New', monospace; font-size: 13px; font-style: inherit; font-variant: inherit; font-weight: inherit; line-height: 1em; overflow: auto; padding: 0px; vertical-align: baseline;"><code class="bash" style="background-color: black; border: 0px; display: block; font-family: Menlo, Monaco, 'Andale Mono', 'lucida console', 'Courier New', monospace !important; font-style: inherit; font-variant: inherit; font-weight: inherit; line-height: 1em; margin: 0px; overflow-x: auto; overflow-y: hidden; padding: 0.8em !important; vertical-align: baseline;"><span style="font-family: inherit; font-style: inherit; font-variant: inherit; font-weight: inherit; line-height: inherit;"><span style="color: #cccccc;">- (</span></span><span style="color: #cc0000; font-family: inherit; font-style: inherit; font-variant: inherit; font-weight: inherit; line-height: inherit;">char</span><span style="color: #cccccc;">) *src = instring, *dst = outstring + len - 1;</span></code><code class="bash" style="background-color: black; border: 0px; display: block; font-family: Menlo, Monaco, 'Andale Mono', 'lucida console', 'Courier New', monospace !important; font-style: inherit; font-variant: inherit; font-weight: inherit; line-height: 1em; margin: 0px; overflow-x: auto; overflow-y: hidden; padding: 0.8em !important; vertical-align: baseline;"><span style="color: #cc0000; font-style: inherit; font-variant: inherit; font-weight: inherit; line-height: 1em;">whille</span><span style="color: #cccccc;"> (*src) * dst-- = *src++;</span></code></pre><div style="background: rgb(255, 255, 255); border: 0px; clear: both; font-family: Arial, 'Liberation Sans', 'DejaVu Sans', sans-serif; font-size: 14px; line-height: 17.8048000335693px; margin-bottom: 1em; padding: 0px; vertical-align: baseline;"><br /></div><div style="background-attachment: initial; background-clip: initial; background-image: initial; background-origin: initial; background-position: initial; background-repeat: initial; background-size: initial; border: 0px; clear: both; font-family: Arial, 'Liberation Sans', 'DejaVu Sans', sans-serif; font-size: 14px; line-height: 17.8048000335693px; margin-bottom: 1em; padding: 0px; vertical-align: baseline;"><span style="background-color: white;">But now the things are changed. Text is unicode now. In most of the languages, there are chances that an API exists which deals string as sequences of UTF-16s.&nbsp;</span><span style="background-color: #eeeeee;">NSString</span><span style="background-color: white;">&nbsp;also is a sequence of UTF-16 units what we call </span><span style="background-color: #eeeeee;">unichars</span><span style="background-color: white;">.&nbsp;</span></div><div style="background-attachment: initial; background-clip: initial; background-image: initial; background-origin: initial; background-position: initial; background-repeat: initial; background-size: initial; border: 0px; clear: both; font-family: Arial, 'Liberation Sans', 'DejaVu Sans', sans-serif; font-size: 14px; line-height: 17.8048000335693px; margin-bottom: 1em; padding: 0px; vertical-align: baseline;"><span style="background-color: white;">So the first thing which comes in mind while dealing with NSStrings is that they are similar to old c strings except that the characters are little wider and the right thing to do is to go and iterate through the string character by character. But that is not the way unicode works.&nbsp;</span></div><div class="separator" style="clear: both; text-align: center;"><a href="http://1.bp.blogspot.com/-X8p7OdlXXRU/VCqFSaRIl8I/AAAAAAAABMo/6Jhk0xuDx0I/s1600/Screenshot%2B2014-09-30%2B15.46.24.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" src="http://1.bp.blogspot.com/-X8p7OdlXXRU/VCqFSaRIl8I/AAAAAAAABMo/6Jhk0xuDx0I/s1600/Screenshot%2B2014-09-30%2B15.46.24.png" height="176" width="400" /></a></div><div style="background-attachment: initial; background-clip: initial; background-image: initial; background-origin: initial; background-position: initial; background-repeat: initial; background-size: initial; border: 0px; clear: both; font-family: Arial, 'Liberation Sans', 'DejaVu Sans', sans-serif; font-size: 14px; line-height: 17.8048000335693px; margin-bottom: 1em; padding: 0px; vertical-align: baseline;"><span style="background-color: white;"><br /></span></div><div style="background-attachment: initial; background-clip: initial; background-image: initial; background-origin: initial; background-position: initial; background-repeat: initial; background-size: initial; border: 0px; clear: both; font-family: Arial, 'Liberation Sans', 'DejaVu Sans', sans-serif; font-size: 14px; line-height: 17.8048000335693px; margin-bottom: 1em; padding: 0px; vertical-align: baseline;"><span style="background-color: white;">A </span><b style="background-color: #eeeeee;">user visible character</b><span style="background-color: white;"> can be composed of more than one unichar. User visible characters also called as:</span></div><div style="background-attachment: initial; background-clip: initial; background-image: initial; background-origin: initial; background-position: initial; background-repeat: initial; background-size: initial; border: 0px; clear: both; margin-bottom: 1em; padding: 0px; vertical-align: baseline;"></div><ul style="text-align: left;"><li><span style="font-family: Arial, Liberation Sans, DejaVu Sans, sans-serif;"><span style="font-size: 14px; line-height: 17.8048000335693px;">Character clusters.</span></span></li><li><span style="font-family: Arial, Liberation Sans, DejaVu Sans, sans-serif;"><span style="font-size: 14px; line-height: 17.8048000335693px;">Grapheme clusters</span></span></li><li><span style="font-family: Arial, Liberation Sans, DejaVu Sans, sans-serif;"><span style="font-size: 14px; line-height: 17.8048000335693px;">Composed character sequence (This term is also used by Apple in its documentation)</span></span></li></ul><span style="font-family: Arial, Liberation Sans, DejaVu Sans, sans-serif;"><span style="font-size: 14px; line-height: 17.8048000335693px;">So if you want to iterate over user visible characters, then you just can't go through each character of NSString. Some characters might be composed of more than one character sequences.</span></span><br /><div style="background-attachment: initial; background-clip: initial; background-image: initial; background-origin: initial; background-position: initial; background-repeat: initial; background-size: initial; border: 0px; clear: both; margin-bottom: 1em; padding: 0px; vertical-align: baseline;"><span style="font-family: Arial, Liberation Sans, DejaVu Sans, sans-serif;"><span style="font-size: 14px; line-height: 17.8048000335693px;">Fox example (From apple's video):</span></span></div><div class="separator" style="clear: both; text-align: center;"><a href="http://1.bp.blogspot.com/-pmFlhz9nw3I/VCqFXGsgeVI/AAAAAAAABMw/iy7nJwPvZfk/s1600/Screenshot%2B2014-09-29%2B15.58.01.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" src="http://1.bp.blogspot.com/-pmFlhz9nw3I/VCqFXGsgeVI/AAAAAAAABMw/iy7nJwPvZfk/s1600/Screenshot%2B2014-09-29%2B15.58.01.png" height="400" width="640" /></a></div><div style="background-attachment: initial; background-clip: initial; background-image: initial; background-origin: initial; background-position: initial; background-repeat: initial; background-size: initial; border: 0px; clear: both; margin-bottom: 1em; padding: 0px; vertical-align: baseline;"><span style="font-family: Arial, Liberation Sans, DejaVu Sans, sans-serif;"><span style="font-size: 14px; line-height: 17.8048000335693px;"><br /></span></span></div><div style="background-attachment: initial; background-clip: initial; background-image: initial; background-origin: initial; background-position: initial; background-repeat: initial; background-size: initial; border: 0px; clear: both; margin-bottom: 1em; padding: 0px; vertical-align: baseline;"><span style="font-family: Arial, Liberation Sans, DejaVu Sans, sans-serif;"><span style="font-size: 14px; line-height: 17.8048000335693px;">So in order to iterate through User Visible Characters, you need to user more Unicode Savvy APIs provided by iOS.</span></span></div><div style="background-attachment: initial; background-clip: initial; background-image: initial; background-origin: initial; background-position: initial; background-repeat: initial; background-size: initial; border: 0px; clear: both; margin-bottom: 1em; padding: 0px; vertical-align: baseline;"><span style="font-family: Arial, Liberation Sans, DejaVu Sans, sans-serif;"><span style="font-size: 14px; line-height: 17.8048000335693px;">If you want to find the first character in NSString which also contains emojis. Emojis are also the example of characters which consists of more than one unichars. So, first thing which comes to mind is:</span></span></div><div class="separator" style="clear: both; text-align: center;"><a href="http://4.bp.blogspot.com/-H6anPfy34KU/VCqKdrQqo-I/AAAAAAAABNg/SNLVIcbKlN0/s1600/Screenshot%2B2014-09-30%2B16.05.28.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" src="http://4.bp.blogspot.com/-H6anPfy34KU/VCqKdrQqo-I/AAAAAAAABNg/SNLVIcbKlN0/s1600/Screenshot%2B2014-09-30%2B16.05.28.png" height="58" width="640" /></a></div><div style="background-attachment: initial; background-clip: initial; background-image: initial; background-origin: initial; background-position: initial; background-repeat: initial; background-size: initial; border: 0px; clear: both; margin-bottom: 1em; padding: 0px; vertical-align: baseline;"><span style="font-family: Arial, 'Liberation Sans', 'DejaVu Sans', sans-serif; font-size: 14px; line-height: 17.8048000335693px;"><br /></span></div><div style="background-attachment: initial; background-clip: initial; background-image: initial; background-origin: initial; background-position: initial; background-repeat: initial; background-size: initial; border: 0px; clear: both; margin-bottom: 1em; padding: 0px; vertical-align: baseline;"><span style="font-family: Arial, 'Liberation Sans', 'DejaVu Sans', sans-serif; font-size: 14px; line-height: 17.8048000335693px;">But when you run this you will not get </span><span style="background-color: #eeeeee; font-family: Arial, 'Liberation Sans', 'DejaVu Sans', sans-serif; font-size: 14px; line-height: 17.8048000335693px;">firstCharacter</span><span style="font-family: Arial, 'Liberation Sans', 'DejaVu Sans', sans-serif; font-size: 14px; line-height: 17.8048000335693px;"> as expected. Instead of getting that first laughing emoji, you will get some other random emoji. This happens because, here in </span><span style="background-color: #eeeeee; font-family: Arial, 'Liberation Sans', 'DejaVu Sans', sans-serif; font-size: 14px; line-height: 17.8048000335693px;">string</span><span style="font-family: Arial, 'Liberation Sans', 'DejaVu Sans', sans-serif; font-size: 14px; line-height: 17.8048000335693px;">, first user visible character is not actually a single unichar but this is actually a composition of two unichars(0xD83D 0xDE03).</span></div><div style="background-attachment: initial; background-clip: initial; background-image: initial; background-origin: initial; background-position: initial; background-repeat: initial; background-size: initial; border: 0px; clear: both; margin-bottom: 1em; padding: 0px; vertical-align: baseline;"><span style="font-family: Arial, Liberation Sans, DejaVu Sans, sans-serif;"><span style="background-color: #eeeeee; font-size: 14px; line-height: 17.8048000335693px;">characterAtIndex </span><span style="background-color: white; font-size: 14px; line-height: 17.8048000335693px;">&nbsp;gives single unichar(0xD83D) and thus character corresponding to that unichar is shown.&nbsp;</span></span></div><div style="background-attachment: initial; background-clip: initial; background-image: initial; background-origin: initial; background-position: initial; background-repeat: initial; background-size: initial; border: 0px; clear: both; margin-bottom: 1em; padding: 0px; vertical-align: baseline;"><span style="font-family: Arial, Liberation Sans, DejaVu Sans, sans-serif;"><span style="background-color: white; font-size: 14px; line-height: 17.8048000335693px;">To correctly get the first visible character(i.e. both&nbsp;</span></span><span style="font-family: Arial, 'Liberation Sans', 'DejaVu Sans', sans-serif; font-size: 14px; line-height: 17.8048000335693px;">0xD83D 0xDE03</span><span style="background-color: white; font-family: Arial, 'Liberation Sans', 'DejaVu Sans', sans-serif; font-size: 14px; line-height: 17.8048000335693px;">), we should do it like:</span></div><div class="separator" style="clear: both; text-align: center;"><a href="http://2.bp.blogspot.com/-Z_Hau18qDrg/VCqJ3q5Q0LI/AAAAAAAABNY/DSlKl0u9hCQ/s1600/Screenshot%2B2014-09-30%2B16.15.43.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" src="http://2.bp.blogspot.com/-Z_Hau18qDrg/VCqJ3q5Q0LI/AAAAAAAABNY/DSlKl0u9hCQ/s1600/Screenshot%2B2014-09-30%2B16.15.43.png" height="130" width="640" /></a></div><div class="separator" style="clear: both; text-align: center;"><br /></div><div class="separator" style="clear: both; text-align: left;"><span style="background-color: white; font-size: 14px; line-height: 17.8048000335693px;"><span style="font-family: Arial, Helvetica, sans-serif;">This correctly gets the first smiling emoji.&nbsp;</span></span><span style="background-color: white; font-family: Arial, Helvetica, sans-serif; font-size: 14px; line-height: 17.8048000335693px;">There are various other APIs provided by Apple to correctly iterate through User visible characters. You can check them in Apple docs.</span></div><div><span style="background-color: white; font-size: 14px; line-height: 17.8048000335693px;"><span style="font-family: Arial, Helvetica, sans-serif;"><br /></span></span></div><div style="background: rgb(255, 255, 255); border: 0px; clear: both; font-size: 14px; line-height: 17.8048000335693px; margin-bottom: 1em; padding: 0px; vertical-align: baseline;"><span style="font-family: Arial, Helvetica, sans-serif;">The most solid way is to use the&nbsp;<code style="background: rgb(238, 238, 238); border: 0px; margin: 0px; padding: 1px 5px; vertical-align: baseline; white-space: pre-wrap;">NSString</code>&nbsp;methods that are sensitive to these characters. You would probably be interested in the&nbsp;<strong style="background: transparent; border: 0px; margin: 0px; padding: 0px; vertical-align: baseline;">WWDC2011 - Session 128 - Advanced Text Processing</strong>&nbsp;video. It talks extensively about just this subject. Pay attention to the part about "Composed Character Sequences"</span></div><div><br /></div></div>