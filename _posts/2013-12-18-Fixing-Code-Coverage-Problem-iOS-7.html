---
layout: post
title: Fixing Code Coverage Problem iOS 7
date: '2013-12-18T09:59:00.000-08:00'
author: Udit
tags:
- Code Coverage
- iOS7
modified_time: '2013-12-18T09:59:53.811-08:00'
---

<div dir="ltr" style="text-align: left;" trbidi="on"><div style="background-color: white; color: #333333; font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif; font-size: 14px; line-height: 1.5; margin-bottom: 20px; word-wrap: break-word;">Code coverage… Back in the days of running on iOS 6 using Xcode 4, measuring code coverage for unit tests was fairly straightforward.&nbsp;A set of coverage scripts&nbsp;made it easier.</div><div style="background-color: white; color: #333333; font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif; font-size: 14px; line-height: 1.5; margin-bottom: 20px; word-wrap: break-word;">Then along came iOS 7 and Xcode 5. Coverage still worked if you continued to run on iOS 6. But on iOS 7, you’d get “ERROR: no .gcda files found” indicating that coverage data wasn’t being captured. “Well, maybe we need to switch from SenTestingKit to Apple’s new XCTest framework.” Nope, that didn’t help.&nbsp;<span id="more-1452" style="word-wrap: break-word;"></span></div><h3 style="background-color: white; color: #444444; font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif; font-size: 24.5px; line-height: 35px; margin: 10px 0px; text-rendering: optimizelegibility; word-wrap: break-word;">Call __gcov_flush() to write out code coverage data</h3><blockquote class="pull" style="background-color: white; border-left-width: 0px; color: #0068c2; float: right; font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif; font-size: 18px; font-style: italic; line-height: 20px; margin: 0px 0px 0px 15px; padding: 0px; width: 180px; word-wrap: break-word;"><div style="font-size: 1em; line-height: 1.5; margin-bottom: 20px; word-wrap: break-word;">But I want to call it just once, after all tests have finished.</div></blockquote><div style="background-color: white; color: #333333; font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif; font-size: 14px; line-height: 1.5; margin-bottom: 20px; word-wrap: break-word;">People starting posting questions on the Apple Developer Forums. Apple’s answer was,&nbsp;<strong style="word-wrap: break-word;">“You have to call __gcov_flush() to collect coverage data with the iOS simulator.”</strong>&nbsp;There was no need to do this before because coverage data is also written when the app exits, which apparently used to happen at the conclusion of unit tests but “we have fixed that.”</div><div style="background-color: white; color: #333333; font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif; font-size: 14px; line-height: 1.5; margin-bottom: 20px; word-wrap: break-word;">Okay, so when do you call __gcov_flush()? The simplest way is to&nbsp;<a href="https://github.com/leroymattingly/XCode5gcovPatch" style="color: #4d8b97; text-decoration: none; word-wrap: break-word;" target="_blank">swizzle tearDown()</a>. The problem with this that __gcov_flush() will be invoked after every test — for one of my projects, that’s over a thousand times! But I want to call it just once, after all tests have finished.</div><h3 style="background-color: white; color: #444444; font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif; font-size: 24.5px; line-height: 35px; margin: 10px 0px; text-rendering: optimizelegibility; word-wrap: break-word;">Test observers to the rescue</h3><div style="background-color: white; color: #333333; font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif; font-size: 14px; line-height: 1.5; margin-bottom: 20px; word-wrap: break-word;">Dave MacLachlan, author of CoverStory, offers a better way, made available through Google Toolbox for Mac (GTM).&nbsp;SenTestingKit and XCTest both have mechanisms for test observers, which Dave puts to work. Here’s how to put his code into your tests:</div><ol style="background-color: white; color: #333333; font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif; font-size: 14px; line-height: 1.5; margin: 0px 0px 20px 45px; padding: 0px; word-wrap: break-word;"><li style="line-height: 1.5; word-wrap: break-word;">Get a copy of the latest GTM source code. You can get it straight from&nbsp;<a href="https://code.google.com/p/google-toolbox-for-mac/source/checkout" style="color: #4d8b97; text-decoration: none; word-wrap: break-word;" target="_blank">the official repository</a>.</li><li style="line-height: 1.5; word-wrap: break-word;">Add UnitTesting/GTMCodeCoverageApp.h and .m to your application. Don’t put them in your test target, they belong in your application target.<br style="word-wrap: break-word;" />If you use XCTest, add GTM_USING_XCTEST=1 to the “Preprocessor Macros” build setting for your application target.</li><li style="line-height: 1.5; word-wrap: break-word;">If you use SenTestingKit, add&nbsp;GTMCodeCoverageTestsST.m to your test target.<br style="word-wrap: break-word;" />If you use XCTest, add&nbsp;GTMCodeCoverageTestsXC.m instead.</li><li style="line-height: 1.5; word-wrap: break-word;">Add GTM_IS_COVERAGE_BUILD=1 to “Preprocessor Macros” for your coverage configuration. Do this at the project level so that it goes into both the app target and the test target.</li></ol><div style="background-color: white; color: #333333; font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif; font-size: 14px; line-height: 1.5; margin-bottom: 20px; word-wrap: break-word;">Your code coverage data is back. Thanks, Dave!</div><div class="sharedaddy sd-sharing-enabled" style="background-color: white; border-bottom-left-radius: 0px !important; border-bottom-right-radius: 0px !important; border-top-left-radius: 0px !important; border-top-right-radius: 0px !important; clear: both; color: #333333; font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif; font-size: 12px; line-height: 20px; word-wrap: break-word; zoom: 1;"><div class="robots-nocontent sd-block sd-social sd-social-official sd-sharing" style="border-bottom-left-radius: 0px !important; border-bottom-right-radius: 0px !important; border-top-color: rgba(0, 0, 0, 0.129412); border-top-left-radius: 0px !important; border-top-right-radius: 0px !important; border-top-style: solid; border-top-width: 1px; margin: 0px; padding: 10px 0px 5px; width: 580px; word-wrap: break-word; zoom: 1;"></div></div></div>